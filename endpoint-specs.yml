- config:
    - testset: Auth 487
    - timeout: 1

- test:
    - name: Index page – No auth
    - url: /
    - expected_status: 200
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {header: 'content-security-policy', expected: "default-src 'none'; style-src 'self'; script-src 'self'; img-src 'self';"}
        - compare: {header: 'x-frame-options', expected: 'deny'}
        - compare: {raw_body: '', comparator: 'contains', expected: '<!-- Page: Auth form -->'}

- test:
    - name: Index page – Auth
    - url: /
    - headers:  {template: {cookie: 'AUTH_TOKEN=$test_auth_token'}}
    - expected_status: 200
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {header: 'content-security-policy', expected: "default-src 'none'; style-src 'self'; script-src 'self'; img-src 'self';"}
        - compare: {header: 'x-frame-options', expected: 'deny'}
        - compare: {raw_body: '', comparator: 'contains', expected: '<!-- Page: User panel -->'}

- test:
    - name: Login – Correct
    - url: /login
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'login=test&password=test&return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 302
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {header: 'content-security-policy', expected: "default-src 'none'; style-src 'self'; script-src 'self'; img-src 'self';"}
        - compare: {header: 'x-frame-options', expected: 'deny'}
        - compare: {header: 'location', comparator: 'contains', expected: '/foo'}
        - compare: {header: 'set-cookie', comparator: 'contains', expected: {template: 'AUTH_TOKEN=$test_auth_token'}}
        - compare: {raw_body: '', comparator: 'contains', expected: 'Redirecting...'}

- test:
    - name: Login – No CSRF in cookies
    - url: /login
    - method: POST
    - headers:
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'login=test&password=test&return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 403
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'No CSRF token'}

- test:
    - name: Login – No CSRF in request
    - url: /login
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'login=test&password=test&return-path=%2Ffoo'}
    - expected_status: 403
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'No CSRF token'}

- test:
    - name: Login – No login
    - url: /login
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'password=test&return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'No auth info'}

- test:
    - name: Login – No password
    - url: /login
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'login=test&return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 400
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'No auth info'}

- test:
    - name: Login – Wrong login
    - url: /login
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'login=test1&password=test&return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 403
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'Wrong login'}

- test:
    - name: Login – Wrong password
    - url: /login
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'login=test&password=test1&return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 403
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'Wrong password'}

- test:
    - name: Logout
    - url: /logout
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
    - body: {template: 'return-path=%2Ffoo&CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 302
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {header: 'location', comparator: 'contains', expected: '/foo'}
        - compare: {header: 'set-cookie', comparator: 'contains', expected: {template: 'AUTH_TOKEN=;'}}
        - compare: {raw_body: '', comparator: 'contains', expected: 'Redirecting...'}

- test:
    - name: Get auth info
    - url: /get-auth-info
    - headers:  {template: {cookie: 'AUTH_TOKEN=$test_auth_token'}}
    - expected_status: 200
    - validators:
        - compare: {header: 'content-type', expected: 'application/json; charset=utf-8'}
        - compare: {jsonpath_mini: '.login', comparator: 'eq', expected: 'test'}

- test:
    - name: Get public key
    - url: /get-public-key
    - expected_status: 200
    - validators:
        - compare: {header: 'content-type', expected: 'text/plain; charset=utf-8'}
        - compare: {raw_body: '', comparator: 'contains', expected: '-----BEGIN PUBLIC KEY-----'}
        - compare: {raw_body: '', comparator: 'contains', expected: '-----END PUBLIC KEY-----'}

- test:
    - name: Get token – Correct
    - url: /get-token
    - method: POST
    - headers:
        - template: {cookie: 'AUTH_TOKEN=$test_auth_token; CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 200
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {header: 'content-security-policy', expected: "default-src 'none'; style-src 'self'; script-src 'self'; img-src 'self';"}
        - compare: {header: 'x-frame-options', expected: 'deny'}
        - compare: {raw_body: '', comparator: 'contains', expected: '<!-- Page: Show token -->'}

- test:
    - name: Get token – No auth
    - url: /get-token
    - method: POST
    - headers:
        - template: {cookie: 'CSRF_TOKEN=$test_csrf_token'}
        - content-type: 'application/x-www-form-urlencoded'
    - body: {template: 'CSRF_TOKEN=$test_csrf_token'}
    - expected_status: 302
    - validators:
        - compare: {header: 'content-type', expected: 'text/html; charset=utf-8'}
        - compare: {header: 'location', expected: 'http://localhost:5487'}
        - compare: {raw_body: '', comparator: 'contains', expected: 'Redirecting...'}
